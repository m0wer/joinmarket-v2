services:
  bitcoin:
    image: kylemanna/bitcoind:latest
    container_name: jm-bitcoin-test
    restart: unless-stopped
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 10
      test: ["CMD-SHELL", "bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getblockchaininfo"]
    command:
      - '-server=1'
      - '-regtest=1'
      - '-rpcauth=test:5e8f6ad6f0d0b6883c3e52f3ae3f1f5$$7b2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e2e'
      - '-rpcuser=test'
      - '-rpcpassword=test'
      - '-rpcallowip=0.0.0.0/0'
      - '-rpcbind=0.0.0.0'
      - '-rpcport=18443'
      - '-txindex=1'
      - '-fallbackfee=0.0002'
      - '-zmqpubrawblock=tcp://0.0.0.0:28332'
      - '-zmqpubrawtx=tcp://0.0.0.0:28333'
    ports:
      - "18443:18443"
      - "18444:18444"
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
      - ./shared:/shared
    networks:
      - jm-test
  # Auto-miner for regtest (mines initial blocks and mempool transactions)
  miner:
    image: kylemanna/bitcoind:latest
    container_name: jm-miner-test
    restart: unless-stopped
    entrypoint: ["/bin/sh", "/scripts/regtest-miner.sh"]
    environment:
      - RPC_HOST=jm-bitcoin-test
      - RPC_PORT=18443
      - RPC_USER=test
      - RPC_PASSWORD=test
      - MINE_INTERVAL=10
    volumes:
      - ../../../scripts:/scripts:ro
    networks:
      - jm-test
    depends_on:
      bitcoin:
        condition: service_healthy

  directory:
    build:
      context: ../../../directory_server
      dockerfile: Dockerfile
    container_name: jm-directory-test
    restart: unless-stopped
    environment:
      - NETWORK=regtest
      - LOG_LEVEL=DEBUG
    ports:
      - "5222:5222"
    networks:
      - jm-test
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.connect(('localhost', 5222)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  bitcoin-data:

networks:
  jm-test:
    driver: bridge
