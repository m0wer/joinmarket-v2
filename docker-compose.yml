# JoinMarket Refactor - Unified Docker Compose
#
# Profiles:
#   (default)  - Core services: bitcoin, miner, directory, orderbook-watcher
#   maker      - Add maker bot
#   taker      - Add taker client
#   e2e        - E2E testing setup with 2 makers (our implementation)
#   reference  - Reference JoinMarket (JAM) for compatibility testing
#   all        - Everything: e2e + reference (for full test suite)
#   neutrino   - Add neutrino light client backend
#
# Usage:
#   docker compose up -d                           # Core services only
#   docker compose --profile maker up -d           # Add maker bot
#   docker compose --profile e2e up -d             # E2E tests (our implementation)
#   docker compose --profile reference up -d       # Reference compatibility tests
#   docker compose --profile all up -d             # Full test suite (all tests)
#
# Run full test suite:
#   docker compose --profile all up -d --build
#   pytest -lv --cov=jmcore --cov=jmwallet --cov=directory_server \
#          --cov=orderbook_watcher --cov=maker --cov=taker \
#          jmcore orderbook_watcher directory_server jmwallet maker taker tests
#   docker compose --profile all down -v

services:
  # ============================================================================
  # Core Services (always available)
  # ============================================================================

  # Bitcoin Core regtest node (main node for our implementation)
  # Uses latest Bitcoin Core (v30+) with descriptor wallets
  bitcoin:
    image: kylemanna/bitcoind:latest
    container_name: jm-bitcoin
    restart: unless-stopped
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 10
      test: ["CMD-SHELL", "bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getblockchaininfo"]
    command:
      - '-server=1'
      - '-regtest=1'
      - '-rpcuser=test'
      - '-rpcpassword=test'
      - '-rpcallowip=0.0.0.0/0'
      - '-rpcbind=0.0.0.0'
      - '-rpcport=18443'
      - '-port=18444'
      - '-txindex=1'
      - '-fallbackfee=0.0002'
      - '-zmqpubrawblock=tcp://0.0.0.0:28332'
      - '-zmqpubrawtx=tcp://0.0.0.0:28333'
      - '-debug=1'
      - '-disablewallet=0'
    ports:
      - "18443:18443"
      - "18444:18444"
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
      - ./shared:/shared
    networks:
      - jm-network

  # Auto-miner for regtest (mines initial blocks and mempool transactions)
  miner:
    image: kylemanna/bitcoind:latest
    container_name: jm-miner
    restart: unless-stopped
    entrypoint: ["/bin/sh", "/scripts/regtest-miner.sh"]
    environment:
      - RPC_HOST=jm-bitcoin
      - RPC_PORT=18443
      - RPC_USER=test
      - RPC_PASSWORD=test
      - MINE_INTERVAL=10
    volumes:
      - ./scripts:/scripts:ro
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy

  # JoinMarket directory server
  # Note: Uses "testnet" as network name for compatibility with reference JoinMarket
  # which uses "testnet" for both testnet and regtest in its protocol messages
  directory:
    build:
      context: .
      dockerfile: directory_server/Dockerfile
    container_name: jm-directory
    restart: unless-stopped
    environment:
      - NETWORK=testnet
      - LOG_LEVEL=INFO
      - PORT=5222
      - HOST=0.0.0.0
    ports:
      - "5222:5222"
    networks:
      - jm-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.connect(('localhost', 5222)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      bitcoin:
        condition: service_healthy

  # Orderbook watcher (web UI for monitoring)
  orderbook-watcher:
    build:
      context: .
      dockerfile: orderbook_watcher/Dockerfile
    container_name: jm-orderbook-watcher
    restart: unless-stopped
    environment:
      - NETWORK=testnet
      - LOG_LEVEL=INFO
      - DIRECTORY_NODES=jm-directory:5222
    ports:
      - "8080:8000"
    networks:
      - jm-network
    depends_on:
      directory:
        condition: service_healthy

  # ============================================================================
  # Maker Bot (profile: maker)
  # ============================================================================

  maker:
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker
    restart: "no"
    environment:
      - MNEMONIC=${MAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=testnet
      - BITCOIN_NETWORK=regtest
      - BACKEND_TYPE=bitcoin_core
      - BITCOIN_RPC_URL=http://jm-bitcoin:18443
      - BITCOIN_RPC_USER=test
      - BITCOIN_RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - MIN_SIZE=10000
      - TX_FEE_CONTRIBUTION=500
      - CJ_FEE_RELATIVE=0.001
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - maker

  # ============================================================================
  # Taker Client (profile: taker)
  # ============================================================================

  taker:
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker
    restart: "no"
    environment:
      - MNEMONIC=${TAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=testnet
      - BITCOIN_NETWORK=regtest
      - BACKEND_TYPE=bitcoin_core
      - BITCOIN_RPC_URL=http://jm-bitcoin:18443
      - BITCOIN_RPC_USER=test
      - BITCOIN_RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - MIN_MAKERS=2
      - MAX_CJ_FEE_REL=0.01
      - MAX_CJ_FEE_ABS=10000
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - taker

  # ============================================================================
  # E2E Test Setup (profile: e2e)
  # Two makers + infrastructure for automated testing
  # ============================================================================

  # Maker 1 for e2e tests
  maker1:
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker1
    restart: unless-stopped
    environment:
      - MNEMONIC=avoid whisper mesh corn already blur sudden fine planet chicken hover sniff
      - NETWORK=testnet
      - BITCOIN_NETWORK=regtest
      - BACKEND_TYPE=bitcoin_core
      - BITCOIN_RPC_URL=http://jm-bitcoin:18443
      - BITCOIN_RPC_USER=test
      - BITCOIN_RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - MIN_SIZE=10000
      - TX_FEE_CONTRIBUTION=500
      - CJ_FEE_RELATIVE=0.0003
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - e2e
      - reference
      - all

  # Maker 2 for e2e tests
  maker2:
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker2
    restart: unless-stopped
    environment:
      - MNEMONIC=minute faint grape plate stock mercy tent world space opera apple rocket
      - NETWORK=testnet
      - BITCOIN_NETWORK=regtest
      - BACKEND_TYPE=bitcoin_core
      - BITCOIN_RPC_URL=http://jm-bitcoin:18443
      - BITCOIN_RPC_USER=test
      - BITCOIN_RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - MIN_SIZE=10000
      - TX_FEE_CONTRIBUTION=500
      - CJ_FEE_RELATIVE=0.00025
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - e2e
      - reference
      - all

  # ============================================================================
  # Reference JoinMarket Implementation (profile: reference)
  # For compatibility testing with upstream JAM
  # ============================================================================

  # Bitcoin Core node specifically for JAM (requires legacy wallets)
  # Uses v28.0 with -deprecatedrpc=create_bdb for legacy wallet support
  # Peers with the main bitcoin node to share the same blockchain
  bitcoin-jam:
    image: lncm/bitcoind:v28.0
    container_name: jm-bitcoin-jam
    restart: unless-stopped
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 10
      test: ["CMD-SHELL", "bitcoin-cli -chain=regtest -rpcport=18445 -rpcuser=test -rpcpassword=test getblockchaininfo"]
    command:
      - '-server=1'
      - '-regtest=1'
      - '-rpcuser=test'
      - '-rpcpassword=test'
      - '-rpcallowip=0.0.0.0/0'
      - '-rpcbind=0.0.0.0'
      - '-rpcport=18445'
      - '-bind=0.0.0.0:18446'
      - '-txindex=1'
      - '-fallbackfee=0.0002'
      - '-debug=1'
      - '-disablewallet=0'
      - '-deprecatedrpc=create_bdb'
      # Connect to main bitcoin node as peer
      - '-addnode=jm-bitcoin:18444'
    ports:
      - "18445:18445"
      - "18446:18446"
    volumes:
      - bitcoin-jam-data:/data/.bitcoin
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - reference
      - all

  # Miner for bitcoin-jam node (creates legacy wallet and mines)
  miner-jam:
    image: lncm/bitcoind:v28.0
    container_name: jm-miner-jam
    restart: unless-stopped
    entrypoint: ["/bin/sh", "/scripts/regtest-miner-jam.sh"]
    environment:
      - RPC_HOST=jm-bitcoin-jam
      - RPC_PORT=18445
      - RPC_USER=test
      - RPC_PASSWORD=test
    volumes:
      - ./scripts:/scripts:ro
    networks:
      - jm-network
    depends_on:
      bitcoin-jam:
        condition: service_healthy
    profiles:
      - reference
      - all

  # Tor hidden service for directory server (exposes directory via .onion)
  # Uses pre-generated keys for deterministic onion address
  # Init container copies keys to a Docker volume with correct ownership
  tor-init:
    image: busybox:latest
    container_name: jm-tor-init
    command: >
      sh -c "
        mkdir -p /var/lib/tor/directory &&
        cp -f /source-keys/hs_ed25519_secret_key /var/lib/tor/directory/ &&
        cp -f /source-keys/hs_ed25519_public_key /var/lib/tor/directory/ &&
        cp -f /source-keys/hostname /var/lib/tor/directory/ &&
        chown -R 1000:1000 /var/lib/tor &&
        chmod 700 /var/lib/tor/directory &&
        chmod 600 /var/lib/tor/directory/* &&
        echo 'Tor keys copied successfully'
      "
    volumes:
      - ./tests/e2e/reference/tor/data/directory:/source-keys:ro
      - tor-data:/var/lib/tor
    profiles:
      - reference
      - all

  tor:
    image: ghcr.io/m0wer/docker-tor:latest
    container_name: jm-tor
    restart: unless-stopped
    volumes:
      - ./tests/e2e/reference/tor/conf:/etc/tor:ro
      - tor-data:/var/lib/tor
    networks:
      - jm-network
    depends_on:
      directory:
        condition: service_healthy
      tor-init:
        condition: service_completed_successfully
    profiles:
      - reference
      - all

  # Reference JoinMarket implementation (jam-standalone)
  # Contains internal Tor daemon for onion messaging
  jam:
    image: ghcr.io/joinmarket-webui/jam-standalone:v0.4.0-clientserver-v0.9.11
    container_name: jm-jam
    environment:
      - JM_RPC_HOST=jm-bitcoin-jam
      - JM_RPC_PORT=18445
      - JM_RPC_USER=test
      - JM_RPC_PASSWORD=test
      - APP_USER=admin
      - APP_PASSWORD=admin
      - ENSURE_WALLET=false
      - REMOVE_LOCK_FILES=true
      - RESTORE_DEFAULT_CONFIG=false
      # Generous fee limits for testing
      - JM_MAX_CJ_FEE_ABS=100000
      - JM_MAX_CJ_FEE_REL=0.01
    volumes:
      - jam-data:/root/.joinmarket
      # Mount custom config with pre-configured onion address
      - ./tests/e2e/reference/joinmarket.cfg:/root/.joinmarket/joinmarket.cfg:ro
      # Mount wallet creation automation script
      - ./tests/e2e/reference/create_wallet.exp:/scripts/create_wallet.exp:ro
    networks:
      - jm-network
    deploy:
      resources:
        limits:
          cpus: "3"
          memory: 2G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "timeout 5 bash -c '</dev/tcp/127.0.0.1/80'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      bitcoin-jam:
        condition: service_healthy
      directory:
        condition: service_healthy
      tor:
        condition: service_started
    profiles:
      - reference
      - all

  # ============================================================================
  # Neutrino Light Client (profile: neutrino)
  # ============================================================================

  neutrino:
    build:
      context: ./neutrino_server
      dockerfile: Dockerfile
    container_name: jm-neutrino
    restart: unless-stopped
    environment:
      - NETWORK=testnet
      - LISTEN_ADDR=0.0.0.0:8334
      - DATA_DIR=/data/neutrino
      - LOG_LEVEL=info
      - CONNECT_PEERS=jm-bitcoin:18444
    ports:
      - "8334:8334"
    volumes:
      - neutrino-data:/data/neutrino
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - neutrino
      - all

  # Maker with neutrino backend
  maker-neutrino:
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker-neutrino
    restart: "no"
    environment:
      - MNEMONIC=${MAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=testnet
      - BITCOIN_NETWORK=regtest
      - BACKEND_TYPE=neutrino
      - NEUTRINO_URL=http://jm-neutrino:8334
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - MIN_SIZE=10000
      - TX_FEE_CONTRIBUTION=500
      - CJ_FEE_RELATIVE=0.001
    networks:
      - jm-network
    depends_on:
      neutrino:
        condition: service_started
      directory:
        condition: service_healthy
    profiles:
      - neutrino
      - all

  # Taker with neutrino backend
  taker-neutrino:
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker-neutrino
    restart: "no"
    environment:
      - MNEMONIC=${TAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=testnet
      - BITCOIN_NETWORK=regtest
      - BACKEND_TYPE=neutrino
      - NEUTRINO_URL=http://jm-neutrino:8334
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - MIN_MAKERS=2
      - MAX_CJ_FEE_REL=0.01
      - MAX_CJ_FEE_ABS=10000
    networks:
      - jm-network
    depends_on:
      neutrino:
        condition: service_started
      directory:
        condition: service_healthy
    profiles:
      - neutrino
      - all

volumes:
  bitcoin-data:
  bitcoin-jam-data:
  neutrino-data:
  jam-data:
  tor-data:

networks:
  jm-network:
    driver: bridge
