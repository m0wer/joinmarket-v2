services:
  # Bitcoin Core regtest node
  # Using kylemanna/bitcoind:latest which is based on v29.1
  bitcoin:
    image: kylemanna/bitcoind:latest
    container_name: jm-bitcoin
    restart: unless-stopped
    healthcheck:
      interval: 10s
      timeout: 10s
      retries: 10
      test: ["CMD-SHELL", "bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getblockchaininfo"]
    command:
      - '-server=1'
      - '-regtest=1'
      - '-rpcuser=test'
      - '-rpcpassword=test'
      - '-rpcallowip=0.0.0.0/0'
      - '-rpcbind=0.0.0.0'
      - '-rpcport=18443'
      - '-txindex=1'
      - '-fallbackfee=0.0002'
      - '-zmqpubrawblock=tcp://0.0.0.0:28332'
      - '-zmqpubrawtx=tcp://0.0.0.0:28333'
      - '-debug=1'
    ports:
      - "18443:18443"
      - "18444:18444"
    volumes:
      - bitcoin-data:/home/bitcoin/.bitcoin
      - ./shared:/shared
    networks:
      - jm-network
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.mining.schedule: "@every 10s"
      ofelia.job-exec.mining.command: |
        sh -c '
        set -e
        export PATH=/usr/local/bin:/usr/bin:/bin

        blockcount=$$(bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getblockcount 2>/dev/null || echo "0")

        # Initial setup - mine to mature coinbase
        if [ "$$blockcount" -lt 101 ]; then
          echo "Initial setup: mining block $$blockcount/101"
          bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test createwallet "test" 2>/dev/null || true
          addr=$$(bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getnewaddress)
          bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test generatetoaddress 10 "$$addr"
          exit 0
        fi

        # Mine mempool transactions
        mempool_count=$$(bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getmempoolinfo | jq -r .size 2>/dev/null || echo "0")

        if [ "$$mempool_count" -gt 0 ]; then
          echo "Mining block with $$mempool_count transactions"
          addr=$$(bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test getnewaddress)
          bitcoin-cli -chain=regtest -rpcport=18443 -rpcuser=test -rpcpassword=test generatetoaddress 1 "$$addr"
        fi
        '

  # Scheduler for auto-mining
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: jm-ofelia
    restart: unless-stopped
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - bitcoin
    networks:
      - jm-network

  # JoinMarket directory server
  directory:
    build:
      context: .
      dockerfile: directory_server/Dockerfile
    container_name: jm-directory
    restart: unless-stopped
    environment:
      - NETWORK=regtest
      - LOG_LEVEL=INFO
      - PORT=5222
    ports:
      - "5222:5222"
    networks:
      - jm-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s = socket.socket(); s.connect(('localhost', 5222)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      bitcoin:
        condition: service_healthy

  # Orderbook watcher (for monitoring)
  orderbook-watcher:
    build:
      context: .
      dockerfile: orderbook_watcher/Dockerfile
    container_name: jm-orderbook-watcher
    restart: unless-stopped
    environment:
      - NETWORK=regtest
      - LOG_LEVEL=INFO
      - DIRECTORY_NODES=jm-directory:5222
    ports:
      - "8080:8080"
    networks:
      - jm-network
    depends_on:
      directory:
        condition: service_healthy

  # Maker bot (to be run manually for testing)
  maker:
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker
    restart: "no"  # Manual start only
    environment:
      - MNEMONIC=${MAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=regtest
      - BACKEND_TYPE=bitcoin_core
      - BITCOIN_RPC_URL=http://jm-bitcoin:18443
      - BITCOIN_RPC_USER=test
      - BITCOIN_RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - MIN_SIZE=10000
      - TX_FEE_CONTRIBUTION=500
      - CJ_FEE_RELATIVE=0.001
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - maker  # Only start with: docker-compose --profile maker up

  # Taker client (to be run manually for testing)
  taker:
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker
    restart: "no"  # Manual start only
    environment:
      - MNEMONIC=${TAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=regtest
      - BACKEND_TYPE=bitcoin_core
      - BITCOIN_RPC_URL=http://jm-bitcoin:18443
      - BITCOIN_RPC_USER=test
      - BITCOIN_RPC_PASSWORD=test
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - MIN_MAKERS=2
      - MAX_CJ_FEE_REL=0.01
      - MAX_CJ_FEE_ABS=10000
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
      directory:
        condition: service_healthy
    profiles:
      - taker  # Only start with: docker-compose --profile taker up

  # Neutrino light client (alternative to Bitcoin Core)
  neutrino:
    build:
      context: ./neutrino_server
      dockerfile: Dockerfile
    container_name: jm-neutrino
    restart: unless-stopped
    environment:
      - NETWORK=regtest
      - LISTEN_ADDR=0.0.0.0:8334
      - DATA_DIR=/data/neutrino
      - LOG_LEVEL=info
      - CONNECT_PEERS=jm-bitcoin:18444
    ports:
      - "8334:8334"
    volumes:
      - neutrino-data:/data/neutrino
    networks:
      - jm-network
    depends_on:
      bitcoin:
        condition: service_healthy
    profiles:
      - neutrino  # Only start with: docker-compose --profile neutrino up

  # Maker with neutrino backend
  maker-neutrino:
    build:
      context: .
      dockerfile: maker/Dockerfile
    container_name: jm-maker-neutrino
    restart: "no"
    environment:
      - MNEMONIC=${MAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=regtest
      - BACKEND_TYPE=neutrino
      - NEUTRINO_URL=http://jm-neutrino:8334
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - MIN_SIZE=10000
      - TX_FEE_CONTRIBUTION=500
      - CJ_FEE_RELATIVE=0.001
    networks:
      - jm-network
    depends_on:
      neutrino:
        condition: service_started
      directory:
        condition: service_healthy
    profiles:
      - neutrino

  # Taker with neutrino backend
  taker-neutrino:
    build:
      context: .
      dockerfile: taker/Dockerfile
    container_name: jm-taker-neutrino
    restart: "no"
    environment:
      - MNEMONIC=${TAKER_MNEMONIC:-abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about}
      - NETWORK=regtest
      - BACKEND_TYPE=neutrino
      - NEUTRINO_URL=http://jm-neutrino:8334
      - DIRECTORY_SERVERS=jm-directory:5222
      - LOG_LEVEL=DEBUG
      - COINJOIN_AMOUNT=1000000
      - MIN_MAKERS=2
      - MAX_CJ_FEE_REL=0.01
      - MAX_CJ_FEE_ABS=10000
    networks:
      - jm-network
    depends_on:
      neutrino:
        condition: service_started
      directory:
        condition: service_healthy
    profiles:
      - neutrino

volumes:
  bitcoin-data:
  neutrino-data:

networks:
  jm-network:
    driver: bridge
