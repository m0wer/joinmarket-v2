services:
  directory_server:
    image: ghcr.io/m0wer/joinmarket-v2-directory-server:master
    # build:
    #   context: ..
    #   dockerfile: directory_server/Dockerfile
    container_name: joinmarket_directory_server
    environment:
      - NETWORK=mainnet
      - HOST=0.0.0.0
      - PORT=5222
      - MAX_PEERS=1000
      - LOG_LEVEL=TRACE
    volumes:
      - ./logs:/app/logs
    networks:
      - joinmarket_directory_internal
    restart: always
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 2 bash -c '</dev/tcp/127.0.0.1/5222' 2>/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: 2
          memory: 1G

  tor:
    image: ghcr.io/m0wer/docker-tor:latest
    container_name: joinmarket_directory_tor
    user: "1000:1000"
    volumes:
      - ./tor/conf:/etc/tor:ro
      - ./tor/data:/var/lib/tor
      - ./tor/run:/var/run/tor
    networks:
      - joinmarket_directory_internal
      - joinmarket_directory_external
    restart: always
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 2 bash -c '</dev/tcp/127.0.0.1/9050' 2>/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: 2
          memory: 300M

networks:
  joinmarket_directory_internal:
    driver: bridge
    internal: true
  joinmarket_directory_external:
    driver: bridge
